import random
from telebot import types
from storage.repositories.users import create_or_update_user
from storage.repositories.credits import get_credits
from storage.repositories.bans import is_banned
from security.channel_guard import is_channel_subscribed, send_channel_prompt
from config.settings import OWNER_HTML

VIDEO_LINKS = [
    "https://t.me/L_O_S_H_A_1/26",
    "https://t.me/L_O_S_H_A_1/27",
    "https://t.me/L_O_S_H_A_1/28",
    "https://t.me/L_O_S_H_A_1/31",
    "https://t.me/L_O_S_H_A_1/34",
    "https://t.me/L_O_S_H_A_1/35",
    "https://t.me/L_O_S_H_A_1/41",
    "https://t.me/L_O_S_H_A_1/67",
    "https://t.me/L_O_S_H_A_1/148",
]

def register_start(bot):

    @bot.message_handler(commands=["start"])
    def start_handler(message):
        user_id = message.from_user.id
        name = message.from_user.first_name or "NoName"
        username = message.from_user.username or "NoUsername"

        # ðŸš« Check banned users
        if is_banned(user_id):
            bot.send_message(
                message.chat.id,
                "ðŸš« You are banned from using this bot."
            )
            return

        # ðŸ”” Check channel subscription
        if not is_channel_subscribed(bot, user_id):
            send_channel_prompt(bot, message.chat.id, name)
            return

        # ðŸ‘¤ Create or update user
        create_or_update_user(
            user_id=user_id,
            username=username,
            first_name=name
        )

        # ðŸ’Ž Check VIP / Credits
        balance = get_credits(user_id)
        if balance == -1:
            vip = True
            vip_text = "âœ… Subscription Active (VIP)"
        else:
            vip = False
            vip_text = f"ðŸ’³ Your Credits: {balance}" if balance > 0 else "âŒ No Credits"

        # ðŸŽ¥ Keyboard
        kb = types.InlineKeyboardMarkup()
        kb.add(types.InlineKeyboardButton(
            "ÏŸ Tool By â‡¾ â¤ÍŸÍž" + OWNER_HTML + " ÏŸ", 
            url="https://t.me/I_EOR"
        ))

        # ðŸ“ Caption message
        if vip:
            caption = f"""âœ¨ Welcome {name} âœ¨

{vip_text}
- Send your combo to check
ÏŸ Tool By â‡¾ {OWNER_HTML} ÏŸ"""
        elif balance > 0:
            caption = f"""âœ¨ Welcome {name} âœ¨

{vip_text}
- Send your combo to check
- Use /buy to get more credits
ÏŸ Tool By â‡¾ {OWNER_HTML} ÏŸ"""
        else:
            caption = f"""âœ¨ Welcome {name} âœ¨

{vip_text}
/cmds | /buy
ÏŸ Tool By â‡¾ {OWNER_HTML} ÏŸ"""

        # ðŸŽ¬ Send video
        bot.send_video(
            chat_id=message.chat.id,
            video=random.choice(VIDEO_LINKS),
            caption=caption,
            reply_markup=kb
        )